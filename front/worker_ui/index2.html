<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Gestor de Flujos de Limpieza</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding: 20px; background-color: #f8f9fa; }
    .hidden { display: none; }
  </style>
</head>
<body>
<div class="container" id="app"></div>

<script>
  function handleDependsChange(resourceId, stepIndex, selectEl) {
  const selectedValues = Array.from(selectEl.selectedOptions).map(opt => parseInt(opt.value));
  const resource = state.resources.find(r => r.id === resourceId) || state.editingResource;
  resource.subworkflow[stepIndex].dependsOn = selectedValues;
  saveState();
}

function updateResourceProblems(value) {
  state.editingResource.problems = value.split(",").map(v => v.trim()).filter(Boolean);
  saveState();
}

  const state = {
    sectors: JSON.parse(localStorage.getItem("sectors")) || [],
    resources: JSON.parse(localStorage.getItem("resources")) || [],
    workflows: JSON.parse(localStorage.getItem("workflows")) || [],
    currentView: "",
  };

  function saveState() {
    localStorage.setItem("sectors", JSON.stringify(state.sectors));
    localStorage.setItem("resources", JSON.stringify(state.resources));
    localStorage.setItem("workflows", JSON.stringify(state.workflows));
  }

  function showHome() {
    state.currentView = "home";
    const app = document.getElementById("app");
    app.innerHTML = `
      <div class="mb-4">
        <h1>Gestor de Flujos de Limpieza</h1>
        <button class="btn btn-primary mt-3" onclick="showSectorEditor()">Gestionar Sectores</button>
        <button class="btn btn-secondary mt-3" onclick="showResourceList()">Gestionar Recursos</button>
        <button class="btn btn-success mt-3" onclick="showWorkflowEditor()">Crear Flujo</button>
      </div>
    `;
  }

  function showSectorEditor() {
    const app = document.getElementById("app");
    const list = state.sectors.map(s => `<li class='list-group-item'>${s.name}</li>`).join("");
    app.innerHTML = `
      <h2>Sectores</h2>
      <ul class="list-group mb-3">${list}</ul>
      <input type="text" id="sectorName" class="form-control mb-3" placeholder="Nombre del Sector">
      <button class="btn btn-primary" onclick="saveSector()">Guardar</button>
      <button class="btn btn-outline-secondary ms-2" onclick="showHome()">Volver</button>
    `;
  }

  function saveSector() {
    const name = document.getElementById("sectorName").value.trim();
    if (name) {
      state.sectors.push({ id: Date.now(), name });
      saveState();
      showSectorEditor();
    }
  }

  function showResourceList() {
    const app = document.getElementById("app");
    const resources = state.resources.map(r => {
      const sector = state.sectors.find(s => s.id === r.sectorId)?.name || "Sin sector";
      return `<li class='list-group-item d-flex justify-content-between align-items-center'>
        <span>${r.name} <small class='text-muted'>(Sector: ${sector})</small></span>
        <button class="btn btn-sm btn-outline-primary" onclick="showResourceEditor(${r.id})">✏️ Editar</button>
      </li>`;
    }).join("");

    app.innerHTML = `
      <h2>Recursos</h2>
      <ul class="list-group mb-3">${resources}</ul>
      <button class="btn btn-primary" onclick="showResourceEditor()">➕ Crear Recurso</button>
      <button class="btn btn-outline-secondary ms-2" onclick="showHome()">Volver</button>
    `;
  }

  function showResourceEditor(resourceId = null) {
  const resource = resourceId
    ? state.resources.find(r => r.id === resourceId)
    : { id: Date.now(), name: "", sectorId: "", problems: [], subworkflow: [] };

  const sectorOptions = state.sectors.map(s =>
    `<option value="${s.id}" ${s.id === resource.sectorId ? "selected" : ""}>${s.name}</option>`
  ).join("");

  const problemsText = (resource.problems || []).join(", ");

  const stepsHTML = resource.subworkflow.map((step, i) => {
    const dependsOptions = resource.subworkflow
      .filter((_, j) => j !== i)
      .map((s, idx) => {
        const selected = (step.dependsOn || []).includes(s.id) ? "selected" : "";
        return `<option value="${s.id}" ${selected}>${s.name || `(Paso ${idx + 1})`}</option>`;
      }).join("");

    return `
      <div class="card card-body mb-3">
        <div class="mb-2">
          <label class="form-label">Nombre del paso</label>
          <input class="form-control" placeholder="Nombre del paso" value="${step.name}" onchange="updateStepField(${resource.id}, ${i}, 'name', this.value)">
        </div>
        <div class="mb-2">
          <label class="form-label">Tiempo estimado (minutos)</label>
          <input class="form-control" type="number" placeholder="Tiempo estimado" value="${step.expectedTime}" onchange="updateStepField(${resource.id}, ${i}, 'expectedTime', this.value)">
        </div>
        <div class="mb-2">
          <label class="form-label">Pasos previos (orden de desbloqueo)</label>
          <select multiple class="form-select" onchange="handleDependsChange(${resource.id}, ${i}, this)">
            ${dependsOptions}
          </select>
        </div>
        <div class="form-check mb-2">
          <input class="form-check-input" type="checkbox" ${step.isPassive ? "checked" : ""} onchange="updateStepField(${resource.id}, ${i}, 'isPassive', this.checked)">
          <label class="form-check-label">Paso pasivo (solo esperar tiempo)</label>
        </div>
      </div>
    `;
  }).join("");

  const app = document.getElementById("app");
  app.innerHTML = `
    <h2>${resourceId ? "Editar" : "Crear"} Recurso</h2>
    <div class="mb-3">
      <label class="form-label">Nombre del Recurso</label>
      <input type="text" id="resourceName" class="form-control" value="${resource.name}">
    </div>
    <div class="mb-3">
      <label class="form-label">Sector</label>
      <select id="sectorSelect" class="form-select">
        <option value="">Seleccionar Sector</option>
        ${sectorOptions}
      </select>
    </div>
    <div class="mb-3">
      <label class="form-label">Problemas posibles (separados por coma)</label>
      <input class="form-control" placeholder="Ej: No había agua, Faltó herramienta" value="${problemsText}" onchange="updateResourceProblems(this.value)">
    </div>
    <h5>Subworkflow</h5>
    <ul class="list-group mb-3">${stepsHTML}</ul>
    <button class="btn btn-outline-secondary btn-sm mb-3" onclick="addStep(${resource.id})">➕ Agregar Paso</button><br>
    <button class="btn btn-primary" onclick="saveResource(${resource.id})">Guardar</button>
    <button class="btn btn-outline-secondary ms-2" onclick="showResourceList()">Volver</button>
  `;

  state.editingResource = resource;
}



  function addStep(resourceId) {
    const resource = state.resources.find(r => r.id === resourceId) || state.editingResource;
    const newStepId = Date.now();
    resource.subworkflow.push({ id: newStepId, name: "", expectedTime: 0, isPassive: false, dependsOn: [], problems: [] });
    saveState();
    showResourceEditor(resourceId);
  }

  function handleDependsChange(resourceId, stepIndex, selectEl) {
  const selectedValues = Array.from(selectEl.selectedOptions).map(opt => parseInt(opt.value));
  const resource = state.resources.find(r => r.id === resourceId) || state.editingResource;
  resource.subworkflow[stepIndex].dependsOn = selectedValues;
  saveState();
}


  function updateStepField(resourceId, index, field, value) {
    const resource = state.resources.find(r => r.id === resourceId) || state.editingResource;
    if (field === "expectedTime") value = parseInt(value);
    if (field === "dependsOn") value = value.split(",").map(v => parseInt(v.trim())).filter(Boolean);
    if (field === "problems") value = value.split(",").map(v => v.trim()).filter(Boolean);
    resource.subworkflow[index][field] = value;
    saveState();
  }

  function saveResource(resourceId) {
    const name = document.getElementById("resourceName").value.trim();
    const sectorId = parseInt(document.getElementById("sectorSelect").value);
    const resource = state.editingResource;
    resource.name = name;
    resource.sectorId = sectorId;

    const existingIndex = state.resources.findIndex(r => r.id === resourceId);
    if (existingIndex !== -1) {
      state.resources[existingIndex] = resource;
    } else {
      state.resources.push(resource);
    }
    saveState();
    showResourceList();
  }

  function showWorkflowEditor() {
    const sectorOptions = state.sectors.map(s => `<option value="${s.id}">${s.name}</option>`).join("");
    const app = document.getElementById("app");
    app.innerHTML = `
      <h2>Crear Flujo</h2>
      <input type="text" id="workflowName" class="form-control mb-3" placeholder="Nombre del Flujo">
      <select id="workflowSector" class="form-select mb-3">
        <option value="">Seleccionar Sector</option>
        ${sectorOptions}
      </select>
      <button class="btn btn-primary" onclick="saveWorkflow()">Guardar</button>
      <button class="btn btn-outline-secondary ms-2" onclick="showHome()">Volver</button>
    `;
  }

  function saveWorkflow() {
    const name = document.getElementById("workflowName").value.trim();
    const sectorId = parseInt(document.getElementById("workflowSector").value);
    if (name && sectorId) {
      state.workflows.push({ id: Date.now(), name, sectorId, steps: [], enabled: false });
      saveState();
      showHome();
    }
  }

  window.addEventListener("DOMContentLoaded", showHome);
</script>
</body>
</html>
